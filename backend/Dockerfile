# === Stage 1: Build ===
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build

WORKDIR /src

# –ö–æ–ø–∏—Ä—É–µ–º csproj –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY *.csproj ./
RUN dotnet restore

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –∏ –ø—É–±–ª–∏–∫—É–µ–º
COPY . ./
RUN dotnet publish -c Release -o /app/publish

# === Stage 2: Runtime ===
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS runtime

WORKDIR /app

# üß© –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º netcat –¥–ª—è wait-for-postgres.sh
RUN apt-get update && apt-get install -y netcat-traditional && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º –ø—É–±–ª–∏–∫—É–µ–º–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ build stage
COPY --from=build /app/publish .

# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –æ–∂–∏–¥–∞–Ω–∏—è Postgres
COPY wait-for-postgres.sh .
RUN chmod +x wait-for-postgres.sh

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ—Ä—Ç
EXPOSE 5000

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –æ–∂–∏–¥–∞–Ω–∏—è Postgres
ENTRYPOINT ["./wait-for-postgres.sh", "postgres", "dotnet", "UEdit.Backend.dll", "--urls=http://0.0.0.0:5000"]
